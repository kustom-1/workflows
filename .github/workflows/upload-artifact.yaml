name: Reusable Backend Deployment to AWS

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: string
      version_tag:
        description: 'Version tag (e.g., v1.2.3)'
        required: false
        type: string
        default: 'latest'
      aws_region:
        description: 'AWS Region'
        required: false
        type: string
        default: 'us-east-1'
      node_version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20.x'
      app_name:
        description: 'Application name'
        required: true
        type: string
      build_command:
        description: 'Build command to execute'
        required: false
        type: string
        default: 'npm run build'
      artifact_path:
        description: 'Path to built artifacts (e.g., dist, build)'
        required: false
        type: string
        default: 'dist'
      s3_artifact_prefix:
        description: 'S3 prefix for artifacts (e.g., backend, frontend)'
        required: false
        type: string
        default: 'backend'
      asg_suffix:
        description: 'ASG name suffix (e.g., application-asg, api-asg)'
        required: false
        type: string
        default: 'application-asg'
      working_directory:
        description: 'Working directory for the app'
        required: false
        type: string
        default: '.'
      health_check_path:
        description: 'Health check endpoint path'
        required: false
        type: string
        default: '/health'
      log_path:
        description: 'Application log path'
        required: false
        type: string
        default: '/var/log/app/'
      install_command:
        description: 'Install dependencies command'
        required: false
        type: string
        default: 'npm ci'
      min_healthy_percentage:
        description: 'Minimum healthy percentage during refresh'
        required: false
        type: number
        default: 50
      instance_warmup:
        description: 'Instance warmup time in seconds'
        required: false
        type: number
        default: 300

      isNext:
        description: 'Flag to indicate if this is a Next.js deployment'
        required: false
        type: boolean
        default: false
      static_assets_bucket_name:
        description: 'Name of the S3 bucket for CloudFront static assets'
        required: false
        type: string
        default: '' 

    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      JWT_SECRET:
        required: false
    
    outputs:
      artifact_url:
        description: "S3 URL of the deployed artifact"
        value: ${{ jobs.build-and-deploy.outputs.artifact_url }}
      refresh_id:
        description: "Instance refresh ID"
        value: ${{ jobs.build-and-deploy.outputs.refresh_id }}

jobs:
  build-and-deploy:
    name: Build and Deploy ${{ inputs.app_name }}
    runs-on: ubuntu-latest

    outputs:
      artifact_url: ${{ steps.upload.outputs.artifact_url }}
      refresh_id: ${{ steps.refresh.outputs.refresh_id }}

    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
      # ==========================================
      # 1. CHECKOUT CODE
      # ==========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================================
      # 2. SETUP NODE.JS
      # ==========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working_directory }}/package-lock.json

      # ==========================================
      # 3. INSTALL DEPENDENCIES
      # ==========================================
      - name: Install dependencies
        run: |
          echo "Installing dependencies for ${{ inputs.app_name }}..."
          ${{ inputs.install_command }}

      # ==========================================
      # 4. BUILD APPLICATION
      # ==========================================
      - name: Build application
        env:
            JWT_SECRET: ${{ secrets.JWT_SECRET }}
            AWS_REGION: ${{ inputs.aws_region }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "Building ${{ inputs.app_name }}..."
          ${{ inputs.build_command }}

          echo "Build completed successfully!"
          # Nota: Si es Next.js, artifact_path debe ser '.next'
          ls -la ${{ inputs.artifact_path }}/
          
      # ==========================================
      # 5. PREPARE DEPLOYMENT ARTIFACT
      # ==========================================
      - name: Prepare deployment artifact
        run: |
          echo "Preparing deployment artifact..."

          mkdir -p deployment
          
          cp -r ${{ inputs.artifact_path }} deployment/
          cp package.json deployment/
          cp package-lock.json deployment/
          cp public deployment/ || true 

          echo "Checking .next structure:"
          ls -la deployment/.next/ || echo ".next not found in deployment"

          # Create artifact metadata
          cat > deployment/ARTIFACT_INFO.txt <<EOF
          Application:   ${{ inputs.app_name }}
          Environment:   ${{ inputs.environment }}
          Build Date:    $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit:    ${{ github.sha }}
          Git Branch:    ${{ github.ref_name }}
          Version:       ${{ inputs.version_tag }}
          Workflow:      ${{ github.workflow }}
          Run Number:    ${{ github.run_number }}
          AWS Region:    ${{ inputs.aws_region }}
          IsNext:        ${{ inputs.isNext }}
          EOF

          # Create the ZIP file
          cd deployment
          zip -r ../app.zip . -x "*.git*" "node_modules/*"
          cd ..

          # Show artifact info
          echo "Artifact created:"
          ls -lh app.zip
          unzip -l app.zip | head -20

      # ==========================================
      # 6. CONFIGURE AWS CREDENTIALS
      # ==========================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      # ==========================================
      # 7. GET AWS ACCOUNT ID
      # ==========================================
      - name: Get AWS Account ID
        id: aws
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=${ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "AWS Account ID: ${ACCOUNT_ID}"

      # ==========================================
      # 8. UPLOAD ARTIFACT TO S3
      # ==========================================
      - name: Upload artifact to S3
        id: upload
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          ACCOUNT_ID: ${{ steps.aws.outputs.account_id }}
          VERSION_TAG: ${{ inputs.version_tag }}
          S3_PREFIX: ${{ inputs.s3_artifact_prefix }}
        run: |
          S3_BUCKET="artifacts-${ENVIRONMENT}-${ACCOUNT_ID}"
          echo "Uploading ${{ inputs.app_name }} to S3 bucket: ${S3_BUCKET}"
          # ... (el resto del script de subida es idéntico) ...
          
          # Upload to versioned path
          if [ "${VERSION_TAG}" != "latest" ]; then
            S3_VERSION_PATH="s3://${S3_BUCKET}/${S3_PREFIX}/${VERSION_TAG}/app.zip"
            echo "Uploading versioned artifact to: ${S3_VERSION_PATH}"
            aws s3 cp app.zip "${S3_VERSION_PATH}" \
              --metadata "app-name=${{ inputs.app_name }},git-commit=${{ github.sha }},build-date=$(date -u +%Y-%m-%d),version=${VERSION_TAG}"
          fi

          # Always upload to latest
          S3_LATEST_PATH="s3://${S3_BUCKET}/${S3_PREFIX}/latest/app.zip"
          echo "Uploading to latest: ${S3_LATEST_PATH}"
          aws s3 cp app.zip "${S3_LATEST_PATH}" \
            --metadata "app-name=${{ inputs.app_name }},git-commit=${{ github.sha }},build-date=$(date -u +%Y-%m-%d),version=${VERSION_TAG}"

          echo "✓ Artifact uploaded successfully!"
          echo "Verifying upload..."
          aws s3 ls "${S3_LATEST_PATH}"
          echo "artifact_url=${S3_LATEST_PATH}" >> $GITHUB_OUTPUT

      # ==========================================
      # 9. TRIGGER AUTO SCALING GROUP REFRESH
      # ==========================================
      - name: Trigger Auto Scaling Group refresh
        id: refresh
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          ASG_SUFFIX: ${{ inputs.asg_suffix }}
        run: |
          # ... (el script de refresh del ASG es idéntico) ...
          ASG_NAME="${ENVIRONMENT}-${ASG_SUFFIX}"
          echo "Triggering instance refresh for ASG: ${ASG_NAME}"
          if aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "${ASG_NAME}" \
              --query 'AutoScalingGroups[0].AutoScalingGroupName' \
              --output text 2>/dev/null | grep -q "${ASG_NAME}"; then
            REFRESH_ID=$(aws autoscaling start-instance-refresh \
              --auto-scaling-group-name "${ASG_NAME}" \
              --preferences '{
                "MinHealthyPercentage": ${{ inputs.min_healthy_percentage }},
                "InstanceWarmup": ${{ inputs.instance_warmup }},
                "CheckpointPercentages": [50, 100],
                "CheckpointDelay": 300
              }' \
              --query 'InstanceRefreshId' \
              --output text)
            echo "Instance refresh started with ID: ${REFRESH_ID}"
            echo "refresh_id=${REFRESH_ID}" >> $GITHUB_OUTPUT
            # ... (resto del script de refresh) ...
          else
            echo "WARNING: ASG '${ASG_NAME}' not found. Skipping instance refresh."
            echo "refresh_id=none" >> $GITHUB_OUTPUT
          fi

      # Upload static assets to S3 if isNext is true
      - name: ☁️ Sync Static Assets to CloudFront S3 Bucket
        
        # La condición ahora comprueba el PREFIJO
        if: inputs.isNext == true && inputs.static_assets_bucket_name != ''
        
        env:
          # Obtenemos las variables para construir el nombre
          ENVIRONMENT: ${{ inputs.environment }}
          ACCOUNT_ID: ${{ steps.aws.outputs.account_id }}
          S3_BUCKET_PREFIX: ${{ inputs.static_assets_bucket_name }}

          # ==== ¡AQUÍ ESTÁ LA MAGIA! ====
          # Construimos el nombre del bucket dinámicamente
          S3_ASSETS_BUCKET: "${{ inputs.static_assets_bucket_name }}-${{ inputs.environment }}-${{ steps.aws.outputs.account_id }}"
          
          WORKING_DIR: ${{ inputs.working_directory }}
        
        run: |
          echo "Next.js flag is TRUE."
          echo "Syncing static assets to CloudFront S3 bucket: ${S3_ASSETS_BUCKET}"

          # Definir las rutas fuente basadas en el working_directory
          NEXT_STATIC_PATH="${WORKING_DIR}/.next/static"
          MODELS_PATH="${WORKING_DIR}/src/models"

          # 1. Sincronizar archivos estáticos de Next.js
          if [ -d "${NEXT_STATIC_PATH}" ]; then
            echo "Syncing ${NEXT_STATIC_PATH} to s3://${S3_ASSETS_BUCKET}/_next/static/"
            aws s3 sync "${NEXT_STATIC_PATH}" "s3://${S3_ASSETS_BUCKET}/_next/static/" --delete
          else
            echo "WARNING: Directory ${NEXT_STATIC_PATH} not found. Skipping sync."
          fi

          # 2. Sincronizar modelos 3D
          if [ -d "${MODELS_PATH}" ]; then
            echo "Syncing ${MODELS_PATH} to s3://${S3_ASSETS_BUCKET}/assets/models/"
            aws s3 sync "${MODELS_PATH}" "s3://${S3_ASSETS_BUCKET}/assets/models/" --delete
          else
            echo "WARNING: Directory ${MODELS_PATH} not found. Skipping sync."
          fi
          
          echo "✓ Static assets sync completed."

      # ==========================================
      # 10. DEPLOYMENT SUMMARY
      # ==========================================
      - name: Deployment summary
        if: always()
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          VERSION_TAG: ${{ inputs.version_tag }}
          ACCOUNT_ID: ${{ steps.aws.outputs.account_id }}
          S3_PREFIX: ${{ inputs.s3_artifact_prefix }}
          ASG_SUFFIX: ${{ inputs.asg_suffix }}
          IS_NEXT: ${{ inputs.isNext }}
          S3_ASSETS_BUCKET: ${{ inputs.static_assets_bucket_name }}
        run: |
          echo ""
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║           DEPLOYMENT SUMMARY                               ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Application:       ${{ inputs.app_name }}"
          echo "Environment:       ${ENVIRONMENT}"
          echo "Version:           ${VERSION_TAG}"
          echo "Git Commit:        ${{ github.sha }}"
          echo ""
          echo "--- Application Server (EC2/ASG) ---"
          echo "S3 Bucket (Artifact): artifacts-${ENVIRONMENT}-${ACCOUNT_ID}"
          echo "S3 Path (latest):   ${S3_PREFIX}/latest/app.zip"
          echo "ASG Name:           ${ENVIRONMENT}-${ASG_SUFFIX}"
          echo "Region:             ${{ inputs.aws_region }}"
          echo ""
          echo "--- Static Assets (CloudFront/S3) ---"
          echo "Is Next.js Deploy:  ${IS_NEXT}"
          if [ "${IS_NEXT}" == "true" ]; then
            echo "S3 Bucket (Assets): ${S3_ASSETS_BUCKET}"
            echo "S3 Path (Next.js):  /_next/static/"
            echo "S3 Path (Models):   /assets/models/"
          fi
          echo ""
          echo "Next steps:"
          echo "1. Monitor instance refresh in AWS Console"
          echo "2. Check application logs: ${{ inputs.log_path }}"
          echo "3. Verify health: http://<alb-dns>${{ inputs.health_check_path }}"
          echo ""